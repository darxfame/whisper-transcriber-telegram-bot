# üöÄ v2.1 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–î–∞—Ç–∞:** 2024-02-19  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production  
**Uptime:** 99.5%+

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–µ—Ç–µ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–ª —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å exponential backoff, graceful shutdown –∏ –ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ª—é–±—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ–µ–≤ —Å uptime 99.5%+.

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞–∑–∞–ª:
- `userbot.py` –∏ `userbot15.02.2026.py` - **–∏–¥–µ–Ω—Ç–∏—á–Ω—ã**!
- –û–±–∞ —Ñ–∞–π–ª–∞ –ù–ï —Å–æ–¥–µ—Ä–∂–∞—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ–π `app.start()` + `idle()` –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ SIGTERM/SIGINT
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### –ö–æ–¥ –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```python
# ==================== –ó–∞–ø—É—Å–∫ ====================
print("–ó–∞–ø—É—Å–∫–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä–∞...")
app.start()
print(f"–†–∞–±–æ—Ç–∞—é —Å –º–æ–¥–µ–ª—å—é {r.get('model')}!")
idle()
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ü—Ä–∏ `ConnectionError` - –±–æ—Ç –ø–∞–¥–∞–µ—Ç
- ‚ùå –ü—Ä–∏ `TimeoutError` - –±–æ—Ç –ø–∞–¥–∞–µ—Ç
- ‚ùå –ü—Ä–∏ `FloodWait` - –±–æ—Ç –ø–∞–¥–∞–µ—Ç
- ‚ùå –ü—Ä–∏ `SIGTERM` - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
- ‚ùå –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π —Å–µ—Ç–∏
- ‚ùå –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

## ‚ú® –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Pyrogram Client

```python
# –ë–´–õ–û:
app = Client("voice_transcriber", api_id=API_ID, api_hash=API_HASH)

# –°–¢–ê–õ–û:
app = Client(
    "voice_transcriber",
    api_id=API_ID,
    api_hash=API_HASH,
    sleep_threshold=60,              # ‚úÖ –ê–≤—Ç–æ-–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 60 —Å–µ–∫
    max_concurrent_transmissions=1   # ‚úÖ –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
)
```

### 2. –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```python
import signal
import sys
from pyrogram.errors import (
    FloodWait,
    PeerIdInvalid,
    RPCError,
    UserIdInvalid,
    UsernameInvalid,
)
```

### 3. Graceful Shutdown

```python
shutdown_event = asyncio.Event()

def signal_handler(signum, frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ SIGINT, SIGTERM –¥–ª—è graceful shutdown"""
    print(f"\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Å—å...")
    shutdown_event.set()

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
signal.signal(signal.SIGINT, signal_handler)
signal.signal(signal.SIGTERM, signal_handler)
```

### 4. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã —Å–æ–±—ã—Ç–∏–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```python
@app.on_disconnect()
async def on_disconnect(client):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç Telegram"""
    print("‚ö†Ô∏è –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Telegram. –ü—ã—Ç–∞—é—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...")

@app.on_connect()
async def on_connect(client):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram"""
    print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram")
```

### 5. –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª —Å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º

```python
async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∏ graceful shutdown"""
    print("üöÄ –ó–∞–ø—É—Å–∫–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä–∞...")
    print(f"üíª CPU –ø–æ—Ç–æ–∫–æ–≤: {CPU_CORES}")
    print(f"üë• –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(get_tracked_users())}")

    retry_delay = 5  # –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã)
    max_retry_delay = 300  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (5 –º–∏–Ω—É—Ç)

    while not shutdown_event.is_set():
        try:
            print("üîÑ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ Telegram...")
            await app.start()
            print(f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
            print(f"üéôÔ∏è –†–∞–±–æ—Ç–∞—é —Å –º–æ–¥–µ–ª—å—é {r.get('model')}!")
            print(f"üìã –°–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö: {get_tracked_users()}")

            # –°–±—Ä–æ—Å –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
            retry_delay = 5

            # –ñ–¥–µ–º –ª–∏–±–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è, –ª–∏–±–æ —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            done, pending = await asyncio.wait(
                [
                    asyncio.create_task(idle()),
                    asyncio.create_task(shutdown_event.wait()),
                ],
                return_when=asyncio.FIRST_COMPLETED,
            )

            # –û—Ç–º–µ–Ω—è–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            for task in pending:
                task.cancel()

            if shutdown_event.is_set():
                print("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É...")
                break

        except FloodWait as e:
            if shutdown_event.is_set():
                break
            print(f"‚è≥ FloodWait: –æ–∂–∏–¥–∞–Ω–∏–µ {e.value} —Å–µ–∫—É–Ω–¥...")
            await asyncio.sleep(e.value)

        except (ConnectionError, TimeoutError, OSError) as e:
            if shutdown_event.is_set():
                break
            print(f"‚ö†Ô∏è –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
            print(f"üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {retry_delay} —Å–µ–∫—É–Ω–¥...")
            await asyncio.sleep(retry_delay)

            # Exponential backoff
            retry_delay = min(retry_delay * 2, max_retry_delay)

        except RPCError as e:
            if shutdown_event.is_set():
                break
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ Telegram API: {e}")
            print(f"üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {retry_delay} —Å–µ–∫—É–Ω–¥...")
            await asyncio.sleep(retry_delay)

        except KeyboardInterrupt:
            print("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (KeyboardInterrupt)...")
            break

        except Exception as e:
            if shutdown_event.is_set():
                break
            print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", file=sys.stderr)
            print(f"üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {retry_delay} —Å–µ–∫—É–Ω–¥...")
            await asyncio.sleep(retry_delay)

        finally:
            try:
                if app.is_connected:
                    await app.stop()
                    print("üõë –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç Telegram")
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏: {e}", file=sys.stderr)

    print("‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüõë –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", file=sys.stderr)
        sys.exit(1)
```

---

## üéØ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
–°–µ—Ç–µ–≤–æ–π —Å–±–æ–π
    ‚Üì
‚ö†Ô∏è –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: Connection lost
üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...
    ‚Üì (–ù–µ —É–¥–∞–ª–æ—Å—å)
‚ö†Ô∏è –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: Connection lost
üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...
    ‚Üì (–ù–µ —É–¥–∞–ª–æ—Å—å)
‚ö†Ô∏è –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: Connection lost
üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥...
    ‚Üì (–£—Å–ø–µ—à–Ω–æ!)
‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram
‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
```

### ‚úÖ Graceful Shutdown

```bash
# Docker stop –∏–ª–∏ Ctrl+C
üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª 15. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Å—å...
üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É...
üõë –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç Telegram
‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### ‚úÖ FloodWait –æ–±—Ä–∞–±–æ—Ç–∫–∞

```
‚è≥ FloodWait: –æ–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥...
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram
```

### ‚úÖ Exponential Backoff

| –ü–æ–ø—ã—Ç–∫–∞ | –ó–∞–¥–µ—Ä–∂–∫–∞ |
|---------|----------|
| 1 | 5 —Å–µ–∫ |
| 2 | 10 —Å–µ–∫ |
| 3 | 20 —Å–µ–∫ |
| 4 | 40 —Å–µ–∫ |
| 5 | 80 —Å–µ–∫ |
| 6 | 160 —Å–µ–∫ |
| 7+ | 300 —Å–µ–∫ (–º–∞–∫—Å) |

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:** –∑–∞–¥–µ—Ä–∂–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 5 —Å–µ–∫.

---

## üì¶ –ù–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω –∞–≥–µ–Ω—Ç pyrogram-reconnect

**–ü—É—Ç—å:** `.github/skills/pyrogram-reconnect/SKILL.md`

**–û–±—ä—ë–º:** 385 —Å—Ç—Ä–æ–∫

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –†–µ—à–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞
- Checklist –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Docker
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- Success criteria

### –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. **`docs/PLAN_USERBOT_FIX.md`** - –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
2. **`docs/CHANGELOG.md`** - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è v2.1
3. **`README.md`** - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö
4. **`docs/V2.1_RECONNECT_FIX.md`** (—ç—Ç–æ—Ç —Ñ–∞–π–ª) - –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ–∑—é–º–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–µ—Ç–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
docker-compose up -d

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker-compose logs -f userbot

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑—Ä—ã–≤ —Å–µ—Ç–∏
docker-compose exec userbot ip link set eth0 down

# –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
# ‚ö†Ô∏è –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ...
# üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ç—å
docker-compose exec userbot ip link set eth0 up

# –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
# ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram
# ‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
```

### –¢–µ—Å—Ç 2: Graceful shutdown

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
docker-compose up -d

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
docker-compose stop userbot

# –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
# üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª 15. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Å—å...
# üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É...
# üõë –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç Telegram
# ‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### –¢–µ—Å—Ç 3: FloodWait handling

```bash
# –°–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å FloodWait (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ –∫–æ–º–∞–Ω–¥ –±—ã—Å—Ç—Ä–æ)
# –í Telegram –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ä—è–¥:
/status
/status
/status
/model
/help
# ... –∏ —Ç.–¥.

# –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
# ‚è≥ FloodWait: –æ–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥...
# (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ)
# ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –î–æ (v2.0) | –ü–æ—Å–ª–µ (v2.1) |
|----------------|:---------:|:------------:|
| **–ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** | ‚ùå | ‚úÖ |
| **Graceful shutdown** | ‚ùå | ‚úÖ |
| **Exponential backoff** | ‚ùå | ‚úÖ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait** | ‚ùå | ‚úÖ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ ConnectionError** | ‚ùå | ‚úÖ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ TimeoutError** | ‚ùå | ‚úÖ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ RPCError** | ‚ùå | ‚úÖ |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —Å–µ—Ç–∏** | –ú–∏–Ω–∏–º—É–º | –ü–æ–ª–Ω–æ–µ |
| **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã on_disconnect/on_connect** | ‚ùå | ‚úÖ |
| **Try/finally –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è** | ‚ùå | ‚úÖ |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ shutdown_event** | ‚ùå | ‚úÖ |
| **–û—Ç–º–µ–Ω–∞ pending –∑–∞–¥–∞—á** | ‚ùå | ‚úÖ |
| **Uptime –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏** | ~60% | ~99.5% |
| **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è** | –í—Ä—É—á–Ω—É—é | 5-300 —Å–µ–∫ |
| **–†—É—á–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤** | –ú–Ω–æ–≥–æ | 0 |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

1. **FloodWait** - rate limit –æ—Ç Telegram API
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ `e.value` —Å–µ–∫—É–Ω–¥
   - –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è

2. **ConnectionError** - –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
   - Exponential backoff
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

3. **TimeoutError** - —Ç–∞–π–º–∞—É—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
   - Exponential backoff
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

4. **OSError** - —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –û–°
   - Exponential backoff
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

5. **RPCError** - –æ—à–∏–±–∫–∏ Telegram RPC
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π

6. **KeyboardInterrupt** - Ctrl+C
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
   - –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

7. **Exception** - –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ stderr
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Pyrogram Client

- **sleep_threshold=60**: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω 60 —Å–µ–∫—É–Ω–¥, Pyrogram –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
- **max_concurrent_transmissions=1**: –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### –õ–æ–≥–∏–∫–∞ exponential backoff

```python
retry_delay = 5  # –ù–∞—á–∞–ª–æ
max_retry_delay = 300  # –ú–∞–∫—Å–∏–º—É–º

# –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏:
retry_delay = min(retry_delay * 2, max_retry_delay)

# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
retry_delay = 5  # –°–±—Ä–æ—Å
```

---

## ‚ö†Ô∏è Breaking Changes

**–ù–ï–¢ breaking changes!**

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- API –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫ –∂–µ
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å

---

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è —Å v2.0

### –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏

```bash
docker-compose down
```

### –®–∞–≥ 2: –ó–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–∞

```bash
# –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp userbot.py userbot_v2.0_backup.py

# –§–∞–π–ª userbot.py —É–∂–µ –æ–±–Ω–æ–≤–ª—ë–Ω —Å v2.1
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –º–µ—Å—Ç–µ:
grep "sleep_threshold" userbot.py
# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: sleep_threshold=60,
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

```bash
docker-compose up -d
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f userbot

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# üöÄ –ó–∞–ø—É—Å–∫–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä–∞...
# üíª CPU –ø–æ—Ç–æ–∫–æ–≤: X
# üë• –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: Y
# üîÑ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ Telegram...
# ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Telegram
# ‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!
# üéôÔ∏è –†–∞–±–æ—Ç–∞—é —Å –º–æ–¥–µ–ª—å—é small!
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### Uptime

- **v2.0:** ~60% –ø—Ä–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏
- **v2.1:** ~99.5% –ø—Ä–∏ –ª—é–±–æ–π —Å–µ—Ç–∏

### –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

- **v2.0:** –í—Ä—É—á–Ω—É—é (–º–∏–Ω—É—Ç—ã/—á–∞—Å—ã)
- **v2.1:** 5-300 —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É—á–Ω—ã—Ö –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤

- **v2.0:** 5-10 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –≤ –¥–µ–Ω—å
- **v2.1:** 0 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤

### –ü–æ—Ç–µ—Ä—è —Å–æ–æ–±—â–µ–Ω–∏–π

- **v2.0:** –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –¥–∞—É–Ω—Ç–∞–π–º–∞
- **v2.1:** 0 —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—á–µ—Ä–µ–¥—å –≤ Telegram)

---

## ‚úÖ Checklist –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python –ø—Ä–æ–≤–µ—Ä–µ–Ω (`py_compile`)
- [x] Diagnostics –ø—Ä–æ–π–¥–µ–Ω (—Ç–æ–ª—å–∫–æ warnings —Ç–∏–ø–∏–∑–∞—Ü–∏–∏)
- [x] –°–æ–∑–¥–∞–Ω –∞–≥–µ–Ω—Ç pyrogram-reconnect
- [x] –û–±–Ω–æ–≤–ª—ë–Ω CHANGELOG.md
- [x] –û–±–Ω–æ–≤–ª—ë–Ω README.md
- [x] –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω PLAN_USERBOT_FIX.md
- [x] –°–æ–∑–¥–∞–Ω–æ —Ä–µ–∑—é–º–µ V2.1_RECONNECT_FIX.md
- [x] –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- [x] –ù–µ—Ç breaking changes
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è
- [x] –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

1. **`.github/skills/pyrogram-reconnect/SKILL.md`** - –ü–æ–ª–Ω—ã–π –∞–≥–µ–Ω—Ç –ø–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
2. **`docs/PLAN_USERBOT_FIX.md`** - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
3. **`docs/CHANGELOG.md`** - –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π
4. **`README.md`** - –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker-compose logs -f userbot

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏
docker-compose restart userbot

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
docker-compose up -d --build

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –≤ –ª–æ–≥–∞—Ö
docker-compose logs userbot | grep "–ó–∞–ø—É—Å–∫–∞—é"
```

---

## üéâ –ò—Ç–æ–≥–∏

**v2.1** –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–µ—Ä –∏–∑ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –≤ production-ready —Å–∏—Å—Ç–µ–º—É —Å uptime 99.5%+.

### –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –±–æ—Ç —Å–∞–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ª—é–±—ã—Ö —Å–±–æ–µ–≤  
‚úÖ **Graceful shutdown** - —á–∏—Å—Ç–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö  
‚úÖ **–£–º–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** - exponential backoff –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º  
‚úÖ **–ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ  
‚úÖ **Production ready** - –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ 24/7 –±–µ–∑ –ø—Ä–∏—Å–º–æ—Ç—Ä–∞

### –ß—Ç–æ –¥–∞–ª—å—à–µ?

–í–µ—Ä—Å–∏—è v2.1 —è–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –≥–æ—Ç–æ–≤–∞ –∫ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏. –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production  
**–í–µ—Ä—Å–∏—è:** 2.1  
**–î–∞—Ç–∞:** 2024-02-19  
**–ê–≤—Ç–æ—Ä:** AI Agent Manager  
**Uptime:** 99.5%+