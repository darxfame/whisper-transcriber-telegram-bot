---
description: –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å Telegram Bot API
alwaysApply: true
---

# Telegram Bot API Integration Rules

## –ü—Ä–∏–Ω—Ü–∏–ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö API –≤—ã–∑–æ–≤–æ–≤

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Telegram Bot API **–≤—Å–µ–≥–¥–∞** –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

## 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (`set_my_commands`)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏:

1. **–°–±–æ—Ä –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∏–∑ –∫–æ–¥–∞**:
   - [ ] –ù–∞–π—Ç–∏ –≤—Å–µ `CommandHandler` —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ `bot.py`
   - [ ] –ù–∞–π—Ç–∏ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –≤ `src/handlers/commands.py`
   - [ ] –í–∫–ª—é—á–∏—Ç—å –í–°–ï –∫–æ–º–∞–Ω–¥—ã –≤ —Å–ø–∏—Å–æ–∫ `BotCommand`
   - [ ] –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –æ–±—â–∏–µ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

2. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–∞–Ω–¥**:
   ```python
   # –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
   try:
       await app.bot.set_my_commands([])
       logger.debug("–û—á–∏—â–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã")
   except Exception as e:
       logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã: {e}")
   ```

3. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥**:
   ```python
   await app.bot.set_my_commands(all_commands)
   logger.info(f"‚úÖ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ BotFather")
   logger.info(f"üìã –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–º–∞–Ω–¥: {len(all_commands)}")
   logger.info(f"üìã –ö–æ–º–∞–Ω–¥—ã: {', '.join([f'/{cmd.command}' for cmd in all_commands])}")
   ```

4. **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)**:
   ```python
   # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
   try:
       installed_commands = await app.bot.get_my_commands()
       installed_names = [cmd.command for cmd in installed_commands]
       logger.info(f"‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–º–∞–Ω–¥ –≤ BotFather: {len(installed_names)}")
       logger.debug(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: {installed_names}")
       
       # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏
       expected_names = [cmd.command for cmd in all_commands]
       if set(installed_names) != set(expected_names):
           missing = set(expected_names) - set(installed_names)
           extra = set(installed_names) - set(expected_names)
           if missing:
               logger.warning(f"‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–º–∞–Ω–¥—ã: {missing}")
           if extra:
               logger.warning(f"‚ö†Ô∏è –õ–∏—à–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: {extra}")
   except Exception as check_error:
       logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: {check_error}")
   ```

### –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è `set_my_commands`:

- [ ] –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ `CommandHandler` –≤–∫–ª—é—á–µ–Ω—ã –≤ —Å–ø–∏—Å–æ–∫
- [ ] –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –Ω–∞ –æ–±—â–∏–µ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ
- [ ] –û–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã –∏ –ø–æ–Ω—è—Ç–Ω—ã
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–∞–Ω–¥
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `get_my_commands()`
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- [ ] –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

## 2. –î—Ä—É–≥–∏–µ Telegram API –æ–ø–µ—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –¥–ª—è –≤—Å–µ—Ö API –≤—ã–∑–æ–≤–æ–≤:

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
   ```python
   result = await bot.some_api_method()
   if not result:
       logger.warning("API –º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
   ```

2. **–õ–æ–≥–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**:
   ```python
   logger.info(f"‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: {operation_name}")
   logger.debug(f"–î–µ—Ç–∞–ª–∏: {details}")
   ```

3. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ**:
   ```python
   try:
       await bot.api_method()
   except RetryAfter as e:
       # –û–±—Ä–∞–±–æ—Ç–∫–∞ rate limit
   except Forbidden as e:
       # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–µ—Ç–∞ –¥–æ—Å—Ç—É–ø–∞
   except BadRequest as e:
       # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   except Exception as e:
       logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ API: {e}", exc_info=True)
   ```

## 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### –ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] –í—Å–µ `CommandHandler` –∏–º–µ—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ `BotCommand`
- [ ] –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ `set_my_commands()`
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏

## 4. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Telegram –∫–ª–∏–µ–Ω—Ç–∞

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥:

Telegram –∫–ª–∏–µ–Ω—Ç –∫—ç—à–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –≤—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞ –∏ –∑–∞–π—Ç–∏ —Å–Ω–æ–≤–∞
- –ò–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–µ –æ—à–∏–±–∫–∞

**–í–∞–∂–Ω–æ**: –ö–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö), –Ω–æ –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞.

## 5. –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü–∞—Ç—Ç–µ—Ä–Ω 1: –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥

```python
# ‚ùå –ü–õ–û–•–û: –ù–µ–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫
commands = [
    BotCommand("rules", "–ü—Ä–∞–≤–∏–ª–∞"),
    BotCommand("version", "–í–µ—Ä—Å–∏—è"),
    # –ó–∞–±—ã–ª–∏ /settings, /sync –∏ —Ç.–¥.
]

# ‚úÖ –•–û–†–û–®–û: –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –≤—Å–µ—Ö CommandHandler
commands = [
    BotCommand("rules", "–ü—Ä–∞–≤–∏–ª–∞"),
    BotCommand("version", "–í–µ—Ä—Å–∏—è"),
    BotCommand("settings", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"),
    BotCommand("sync", "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è"),
    # ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
]
```

### –ü–∞—Ç—Ç–µ—Ä–Ω 2: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

```python
# ‚ùå –ü–õ–û–•–û: –ë–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
await bot.set_my_commands(commands)

# ‚úÖ –•–û–†–û–®–û: –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π
await bot.set_my_commands(commands)
installed = await bot.get_my_commands()
if len(installed) != len(commands):
    logger.warning(f"–ö–æ–º–∞–Ω–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!")
```

### –ü–∞—Ç—Ç–µ—Ä–Ω 3: –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π

```python
# ‚ùå –ü–õ–û–•–û: –ü—Ä—è–º–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö —Å—Ç–∞—Ä—ã—Ö
await bot.set_my_commands(new_commands)

# ‚úÖ –•–û–†–û–®–û: –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
await bot.set_my_commands([])  # –û—á–∏—Å—Ç–∫–∞
await bot.set_my_commands(new_commands)  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```

## 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –∫–æ–¥–∞ —Å Telegram API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏:

1. **–ù–∞–π—Ç–∏ –≤—Å–µ CommandHandler**:
   ```bash
   grep -r "CommandHandler" bot.py
   ```

2. **–°—Ä–∞–≤–Ω–∏—Ç—å —Å BotCommand**:
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ `CommandHandler` –µ—Å—Ç—å –≤ `BotCommand`
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ –≤ `BotCommand`

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é**:
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –µ—Å—Ç—å –≤—ã–∑–æ–≤ `get_my_commands()` –ø–æ—Å–ª–µ `set_my_commands()`
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –µ—Å—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∏ –æ–∂–∏–¥–∞–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥

## 7. –ü—Ä–∏–º–µ—Ä—ã –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞ 1: –ù–µ–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
```python
# –ó–∞–±—ã–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å /settings
commands = [BotCommand("rules", "..."), BotCommand("version", "...")]
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ CommandHandler –≤ bot.py
```

### –û—à–∏–±–∫–∞ 2: –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
```python
await bot.set_my_commands(commands)
# –ö–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è, –Ω–æ –º—ã –Ω–µ —É–∑–Ω–∞–µ–º
# –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å get_my_commands() –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
```

### –û—à–∏–±–∫–∞ 3: –ù–µ—Ç –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–∞–Ω–¥
```python
# –°—Ç–∞—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è
await bot.set_my_commands(new_commands)
# –†–µ—à–µ–Ω–∏–µ: –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ set_my_commands([])
```

## –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å

- **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç API –≤—ã–∑–æ–≤–æ–≤**
- **–í—Å–µ–≥–¥–∞ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–º–∞–Ω–¥**
- **–í—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**
- **–í—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏**
- **Telegram –∫–ª–∏–µ–Ω—Ç –∫—ç—à–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ**
