---
description: Обязательный порядок применения агентов при работе с кодом
alwaysApply: true
---

# Обязательный порядок применения агентов

## Критически важно!

**Агенты должны применяться в строгом порядке. Пропуск любого шага может привести к ошибкам в продакшене!**

## Порядок применения (строго соблюдать!)

### Этап 1: Планирование (до кодирования)
1. **Определить контекст**:
   - Какой файл редактируется?
   - Какая задача выполняется?
   - Какие агенты применимы?

2. **Прочитать релевантные агенты**:
   - Из `.cursor/skills/` для специализированных задач
   - Из `AGENTS.md` для общих задач
   - Понять требования и чеклисты
   - **КРИТИЧНО**: При работе с Telegram API → прочитать `telegram-api-check`

3. **Составить план реализации**:
   - Определить все шаги выполнения
   - Определить все проверки и верификации
   - Определить все логирования
   - Убедиться что план полный

### Этап 2: Кодирование
3. **Следовать правилам агентов**:
   - Применять паттерны из агентов
   - Следовать чеклистам
   - Использовать правильные практики

### Этап 3: Проверка (после кодирования, ОБЯЗАТЕЛЬНО!)

4. **Синтаксическая проверка (КРИТИЧНО - ПЕРВАЯ И ОБЯЗАТЕЛЬНАЯ!)**:
   ```bash
   read_lints(['path/to/file.py'])
   ```
   - **ОБЯЗАТЕЛЬНО** запустить для ВСЕХ измененных файлов
   - Проверить на `SyntaxError`, `IndentationError`
   - Проверить на `NameError`, `UnboundLocalError`
   - **Если есть ошибки**:
     - ❌ НЕ завершать задачу
     - ❌ НЕ коммитить код
     - ✅ ИСПРАВИТЬ все ошибки
     - ✅ Запустить `read_lints` снова
     - ✅ Убедиться что ошибок нет

5. **Проверка импортов (КРИТИЧНО!)**:
   - [ ] Нет дубликатов импортов внутри функций
   - [ ] Нет shadowing imports (импорт внутри функции при наличии на уровне модуля)
   - [ ] Все импорты используются
   - [ ] Порядок импортов правильный

6. **Проверка UnboundLocalError (КРИТИЧНО!)**:
   - [ ] Если модуль импортирован на уровне модуля (например, `import sys`)
   - [ ] НЕ импортировать его снова внутри функции
   - [ ] Использовать модуль напрямую: `sys.stderr` вместо `import sys` внутри функции

7. **Применение code-review агента**:
   - [ ] Запустить полный чеклист из `.cursor/skills/code-review/SKILL.md`
   - [ ] Проверить все пункты из Pre-Commit Checklist
   - [ ] Убедиться что все проверки пройдены

8. **Применение специфичных агентов** (если применимо):
   - [ ] При работе с Telegram API → применить `telegram-api-check`
   - [ ] При работе с БД → применить `database-sync` или `database-init`
   - [ ] При работе с логированием → применить `railway-logging`
   - [ ] Проверить все чеклисты специфичных агентов

8. **Проверка паттернов проекта**:
   - [ ] Соответствие `systemPatterns.md`
   - [ ] Правильная обработка ошибок
   - [ ] Правильное логирование
   - [ ] Безопасность (SQL injection, PII)

### Этап 4: Документация (перед коммитом)

9. **Обновление версии**:
   - [ ] Обновить `BOT_VERSION` в `src/config.py`
   - [ ] Увеличить версию согласно изменениям:
     - Patch (Z) для исправлений багов
     - Minor (Y) для новых функций
     - Major (X) для breaking changes

10. **Обновление memory-bank**:
    - [ ] Добавить запись в `memory-bank/activeContext.md`
    - [ ] Описать что было исправлено/добавлено/изменено
    - [ ] Указать измененные файлы

### Этап 5: Финальная проверка

11. **Финальная проверка**:
    - [ ] Запустить `read_lints` еще раз
    - [ ] Убедиться что нет ошибок
    - [ ] Проверить что все изменения сохранены

12. **Готовность к коммиту**:
    - [ ] Все проверки пройдены
    - [ ] Версия обновлена
    - [ ] Memory-bank обновлен
    - [ ] Код готов к коммиту

## Критические проверки (никогда не пропускать!)

### ✅ Обязательные проверки перед каждым коммитом:

1. **`read_lints`** - синтаксис Python корректен
2. **UnboundLocalError check** - нет дубликатов импортов
3. **Shadowing imports check** - нет импортов внутри функций при наличии на уровне модуля
4. **Code-review agent** - полный чеклист пройден
5. **Version updated** - версия обновлена
6. **Memory-bank updated** - изменения задокументированы

## Примеры ошибок, которые агенты должны ловить

### ❌ UnboundLocalError (критическая ошибка!)
```python
import sys  # Модуль-уровень

def setup_logging():
    handler = logging.StreamHandler(sys.stdout)  # Использует sys
    if condition:
        import sys  # ОШИБКА! Shadowing import
        print("...", file=sys.stderr)  # UnboundLocalError!
```
**Решение**: Удалить `import sys` из функции, использовать модуль-уровень импорт.

### ❌ NameError
```python
def func():
    print(x)  # x не определена
    x = 5
```
**Решение**: Определить переменную перед использованием.

### ❌ SyntaxError
```python
if condition:
    pass
else:
    # Пустой блок
```
**Решение**: Добавить `pass` или код в блок.

## Автоматическое применение

Агенты применяются автоматически на основе:
- **Пути файла** → определяет релевантных агентов
- **Типа задачи** → определяет какие агенты нужны
- **Контекста** → определяет порядок применения

Но **всегда** нужно:
1. Запускать `read_lints`
2. Проверять импорты
3. Применять code-review агента
4. Обновлять версию и memory-bank

## Важно помнить

- **Агенты не заменяют внимательность** - всегда проверяйте код вручную
- **Порядок важен** - не пропускайте шаги
- **Критические проверки обязательны** - они предотвращают ошибки в продакшене
- **Документация обязательна** - версия и memory-bank должны быть обновлены
